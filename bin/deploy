#!/usr/bin/env bash

if [ -z "$1" ]; then
  echo 'ARTIFACTORY_PASSWORD is required'
  exit 1
fi

ARTIFACTORY_USER=travis-ci
ARTIFACTORY_PASSWORD=$1
GEM_HOST=localytics.artifactoryonline.com/localytics/api/gems/ruby-gems-local

function failOnBadExitStatus() {
  if [ "$?" -ne 0 ]; then
    echo 'Command failed... exiting'
    exit 1
  fi
}

function deploy {
  echo 'Building gem...'
  gem build laws.gemspec
  failOnBadExitStatus

  echo 'Adding gem source'
  gem source -a https://${ARTIFACTORY_USER}:${ARTIFACTORY_PASSWORD}@${GEM_HOST}/

  echo 'Getting API key'
  curl https://${GEM_HOST}/api/v1/api_key.yaml -u ${ARTIFACTORY_USER}:${ARTIFACTORY_PASSWORD} > ~/.gem/credentials
  failOnBadExitStatus
  chmod 0600 ~/.gem/credentials

  echo 'Uploading to artifactory...'
  response=$(gem push laws*.gem --host https://${GEM_HOST})
  if [ "$?" -ne 0 ]; then
    echo "Gem push failed: $response"
    exit 1
  else
    echo "Gem push succeeded: $response"
  fi

  echo 'Creating a pushing git tag'
  gem_version=$(ruby -I lib -e "require 'laws/version'; puts Laws::VERSION")
  git config --global user.email "techops-team+travis@localytics.com"
  git config --global user.name "Travis CI"
  git tag -a "$gem_version" -m "Version $gem_version"
  failOnBadExitStatus
  git push origin "$gem_version"
  failOnBadExitStatus
}

if [[ $TRAVIS_PULL_REQUEST == "false" ]] && [[ $TRAVIS_BRANCH == "master" ]]; then
  deploy
fi
